//Slave1 - Laptop: Comm15 / PC: Comm4 - Channel A (Blue)

/*
Date: May 2018
Organization: BCCRC Imaging Unit
Authors: Varalee Chinbomsom and Daniela Tay Lee Sanchez
Description: This script is for slave1 of the I2C connection
To receive a signal from the master and start generating the sine wave 
The signal should be the number of samples in the sine lookup table
*/

#include <Wire.h> // Include the required Wire library for I2C

//Constants
#define DAC_RESOLUTION 12
#define I2C_ADDRESS 0x04 //Can use script I2C_DEVICE_SCANNER to get address
#define PI 3.14159265358979323846

//Variables
int samples = 0; //Num of samples
int i = 0; //Iterate through wave values for sine wave
int x = 0; //Signal to receive from master

//Lookup tables max value 4095 (2^12 bc 12 bit DAC)
static int sinewave1[2048] = 
{
};

static int sinewave2[1024] = 
{
2048,2060,2073,2085,2098,2110,2123,2136,2148,2161,2173,2186,2198,2211,2223,2236,2248,2261,2273,2286,2298,2311,2323,2336,2348,
2361,2373,2385,2398,2410,2423,2435,2447,2460,2472,2484,2497,2509,2521,2533,2545,2558,2570,2582,2594,2606,2618,2630,2642,2654,
2666,2678,2690,2702,2714,2726,2738,2750,2762,2773,2785,2797,2808,2820,2832,2843,2855,2866,2878,2889,2901,2912,2924,2935,2946,
2958,2969,2980,2991,3002,3014,3025,3036,3047,3058,3069,3079,3090,3101,3112,3123,3133,3144,3154,3165,3176,3186,3196,3207,3217,
3227,3238,3248,3258,3268,3278,3288,3298,3308,3318,3328,3338,3347,3357,3367,3376,3386,3395,3405,3414,3424,3433,3442,3451,3460,
3470,3479,3487,3496,3505,3514,3523,3532,3540,3549,3557,3566,3574,3582,3591,3599,3607,3615,3623,3631,3639,3647,3655,3663,3670,
3678,3686,3693,3701,3708,3715,3723,3730,3737,3744,3751,3758,3765,3772,3778,3785,3792,3798,3805,3811,3818,3824,3830,3836,3842,
3848,3854,3860,3866,3872,3877,3883,3889,3894,3899,3905,3910,3915,3920,3925,3930,3935,3940,3945,3949,3954,3959,3963,3968,3972,
3976,3980,3984,3988,3992,3996,4000,4004,4008,4011,4015,4018,4022,4025,4028,4031,4034,4037,4040,4043,4046,4049,4051,4054,4056,
4059,4061,4063,4065,4067,4069,4071,4073,4075,4077,4078,4080,4081,4083,4084,4085,4087,4088,4089,4090,4091,4091,4092,4093,4093,
4094,4094,4094,4095,4095,4095,4095,4095,4095,4095,4094,4094,4093,4093,4092,4092,4091,4090,4089,4088,4087,4086,4085,4084,4082,
4081,4079,4078,4076,4074,4072,4070,4068,4066,4064,4062,4060,4057,4055,4052,4050,4047,4044,4042,4039,4036,4033,4030,4026,4023,
4020,4016,4013,4009,4006,4002,3998,3994,3990,3986,3982,3978,3974,3970,3965,3961,3956,3952,3947,3942,3938,3933,3928,3923,3918,
3913,3907,3902,3897,3891,3886,3880,3875,3869,3863,3857,3851,3845,3839,3833,3827,3821,3814,3808,3802,3795,3788,3782,3775,3768,
3761,3755,3748,3740,3733,3726,3719,3712,3704,3697,3689,3682,3674,3667,3659,3651,3643,3635,3627,3619,3611,3603,3595,3587,3578,
3570,3561,3553,3544,3536,3527,3518,3510,3501,3492,3483,3474,3465,3456,3447,3438,3428,3419,3410,3400,3391,3381,3372,3362,3352,
3343,3333,3323,3313,3303,3293,3283,3273,3263,3253,3243,3233,3222,3212,3202,3191,3181,3170,3160,3149,3139,3128,3117,3106,3096,
3085,3074,3063,3052,3041,3030,3019,3008,2997,2986,2975,2963,2952,2941,2929,2918,2907,2895,2884,2872,2861,2849,2838,2826,2814,
2803,2791,2779,2767,2756,2744,2732,2720,2708,2696,2684,2672,2660,2648,2636,2624,2612,2600,2588,2576,2564,2552,2539,2527,2515,
2503,2490,2478,2466,2453,2441,2429,2416,2404,2392,2379,2367,2354,2342,2330,2317,2305,2292,2280,2267,2255,2242,2230,2217,2205,
2192,2179,2167,2154,2142,2129,2117,2104,2092,2079,2066,2054,2041,2029,2016,2003,1991,1978,1966,1953,1941,1928,1916,1903,1890,
1878,1865,1853,1840,1828,1815,1803,1790,1778,1765,1753,1741,1728,1716,1703,1691,1679,1666,1654,1642,1629,1617,1605,1592,1580,
1568,1556,1543,1531,1519,1507,1495,1483,1471,1459,1447,1435,1423,1411,1399,1387,1375,1363,1351,1339,1328,1316,1304,1292,1281,
1269,1257,1246,1234,1223,1211,1200,1188,1177,1166,1154,1143,1132,1120,1109,1098,1087,1076,1065,1054,1043,1032,1021,1010,999,
989,978,967,956,946,935,925,914,904,893,883,873,862,852,842,832,822,812,802,792,782,772,762,752,743,
733,723,714,704,695,685,676,667,657,648,639,630,621,612,603,594,585,577,568,559,551,542,534,525,517,
508,500,492,484,476,468,460,452,444,436,428,421,413,406,398,391,383,376,369,362,355,347,340,334,327,
320,313,307,300,293,287,281,274,268,262,256,250,244,238,232,226,220,215,209,204,198,193,188,182,177,
172,167,162,157,153,148,143,139,134,130,125,121,117,113,109,105,101,97,93,89,86,82,79,75,72,
69,65,62,59,56,53,51,48,45,43,40,38,35,33,31,29,27,25,23,21,19,17,16,14,13,
11,10,9,8,7,6,5,4,3,3,2,2,1,1,0,0,0,0,0,0,0,1,1,1,2,
2,3,4,4,5,6,7,8,10,11,12,14,15,17,18,20,22,24,26,28,30,32,34,36,39,
41,44,46,49,52,55,58,61,64,67,70,73,77,80,84,87,91,95,99,103,107,111,115,119,123,
127,132,136,141,146,150,155,160,165,170,175,180,185,190,196,201,206,212,218,223,229,235,241,247,253,
259,265,271,277,284,290,297,303,310,317,323,330,337,344,351,358,365,372,380,387,394,402,409,417,425,
432,440,448,456,464,472,480,488,496,504,513,521,529,538,546,555,563,572,581,590,599,608,616,625,635,
644,653,662,671,681,690,700,709,719,728,738,748,757,767,777,787,797,807,817,827,837,847,857,868,878,
888,899,909,919,930,941,951,962,972,983,994,1005,1016,1026,1037,1048,1059,1070,1081,1093,1104,1115,1126,1137,1149,
1160,1171,1183,1194,1206,1217,1229,1240,1252,1263,1275,1287,1298,1310,1322,1333,1345,1357,1369,1381,1393,1405,1417,1429,1441,
1453,1465,1477,1489,1501,1513,1525,1537,1550,1562,1574,1586,1598,1611,1623,1635,1648,1660,1672,1685,1697,1710,1722,1734,1747,
1759,1772,1784,1797,1809,1822,1834,1847,1859,1872,1884,1897,1909,1922,1934,1947,1959,1972,1985,1997,2010,2022,2035,2048
};

static int sinewave3[512] = 
{
2048,2073,2098,2123,2148,2173,2198,2224,2249,2274,2299,2324,2349,2373,2398,2423,2448,2472,2497,2522,2546,2570,2595,2619,2643,
2667,2691,2715,2739,2762,2786,2809,2832,2856,2879,2902,2925,2947,2970,2992,3014,3037,3059,3080,3102,3123,3145,3166,3187,3208,
3228,3249,3269,3289,3309,3329,3349,3368,3387,3406,3425,3443,3462,3480,3498,3515,3533,3550,3567,3584,3600,3616,3632,3648,3664,
3679,3694,3709,3724,3738,3752,3766,3779,3793,3806,3819,3831,3843,3855,3867,3878,3889,3900,3911,3921,3931,3941,3950,3960,3968,
3977,3985,3993,4001,4008,4015,4022,4029,4035,4041,4046,4052,4057,4061,4066,4070,4074,4077,4080,4083,4086,4088,4090,4092,4093,
4094,4095,4095,4095,4095,4094,4093,4092,4091,4089,4087,4084,4082,4079,4075,4072,4068,4064,4059,4054,4049,4044,4038,4032,4026,
4019,4012,4005,3997,3989,3981,3973,3964,3955,3946,3936,3926,3916,3906,3895,3884,3873,3861,3849,3837,3825,3812,3799,3786,3773,
3759,3745,3731,3716,3702,3687,3672,3656,3640,3624,3608,3592,3575,3558,3541,3524,3506,3489,3471,3452,3434,3415,3397,3377,3358,
3339,3319,3299,3279,3259,3239,3218,3197,3177,3155,3134,3113,3091,3069,3048,3025,3003,2981,2958,2936,2913,2890,2867,2844,2821,
2797,2774,2750,2727,2703,2679,2655,2631,2607,2582,2558,2534,2509,2485,2460,2435,2411,2386,2361,2336,2311,2286,2261,2236,2211,
2186,2161,2136,2110,2085,2060,2035,2010,1985,1959,1934,1909,1884,1859,1834,1809,1784,1759,1734,1709,1684,1660,1635,1610,1586,
1561,1537,1513,1488,1464,1440,1416,1392,1368,1345,1321,1298,1274,1251,1228,1205,1182,1159,1137,1114,1092,1070,1047,1026,1004,
982,961,940,918,898,877,856,836,816,796,776,756,737,718,698,680,661,643,624,606,589,571,554,537,520,
503,487,471,455,439,423,408,393,379,364,350,336,322,309,296,283,270,258,246,234,222,211,200,189,179,
169,159,149,140,131,122,114,106,98,90,83,76,69,63,57,51,46,41,36,31,27,23,20,16,13,
11,8,6,4,3,2,1,0,0,0,0,1,2,3,5,7,9,12,15,18,21,25,29,34,38,
43,49,54,60,66,73,80,87,94,102,110,118,127,135,145,154,164,174,184,195,206,217,228,240,252,
264,276,289,302,316,329,343,357,371,386,401,416,431,447,463,479,495,511,528,545,562,580,597,615,633,
652,670,689,708,727,746,766,786,806,826,846,867,887,908,929,950,972,993,1015,1036,1058,1081,1103,1125,1148,
1170,1193,1216,1239,1263,1286,1309,1333,1356,1380,1404,1428,1452,1476,1500,1525,1549,1573,1598,1623,1647,1672,1697,1722,1746,
1771,1796,1821,1846,1871,1897,1922,1947,1972,1997,2022,2048
};

static int sinewave4[256] = 
{
};


//Method to configure Arduino
void setup() 
{
   //Start the I2C Bus as Slave on address 
   Wire.begin(I2C_ADDRESS); 

   pinMode(DAC1, OUTPUT);  
   pinMode(39, INPUT);  
   pinMode(51, INPUT); 
    
   analogWriteResolution(DAC_RESOLUTION); //Set up resolution
   attachInterrupt(digitalPinToInterrupt(51), pin_ISR, RISING); //Call pin_ISR when 51 goes from low to high
   Wire.onReceive(receiveEvent);
}

//Method to set the signal to what was transfered by master
void receiveEvent(int bytes) 
{
  x = Wire.read(); //Read one character from the I2C master and assign to x
}


//Method to loop indefinetely
void loop() 
{
    Wire.onReceive(receiveEvent); //Receive signal from master to start
    samples = 1024; //Depends on what master says
}

void pin_ISR() 
{
  if (x>0) //If master wants to start
  {
    analogWrite(DAC1, sinewave2[i]);
    i = (i+1)%samples;
  }
}



